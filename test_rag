#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import logging
import tempfile
from datetime import datetime
from pathlib import Path
from typing import Optional, List, Dict, Any


from gigachat.models import Chat, Messages, MessagesRole
from gigachat import GigaChat
from telegram import Update
from telegram.ext import (
    Application,
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)
from chromadb import Client, Settings
from chromadb.utils import embedding_functions
import PyPDF2
from docx import Document
from nltk.tokenize import sent_tokenize

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
    handlers=[
        logging.FileHandler("bot_operations.log"),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# –ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
class AppConfig:
    GIGACHAT_CREDENTIALS = ""
    TELEGRAM_BOT_TOKEN = ""
    ALLOWED_USERS = ["5210371611"]
    MAX_FILE_SIZE = 20 * 1024 * 1024  # 10 MB
    CHUNK_SIZE = 1000
    PERSIST_DIRECTORY = "./chroma_db"
    EMBEDDING_MODEL = "sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"

class DocumentProcessor:
    """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    
    @staticmethod
    def extract_text_from_file(file_path: str) -> str:
        """–ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞"""
        try:
            ext = Path(file_path).suffix.lower()
            
            if ext == '.pdf':
                return DocumentProcessor._extract_from_pdf(file_path)
            elif ext == '.docx':
                return DocumentProcessor._extract_from_docx(file_path)
            elif ext == '.txt':
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    if not content.strip():
                        raise ValueError("–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –ø—É—Å—Ç")
                    return content
            else:
                raise ValueError(f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: {ext}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞: {str(e)}")
            raise

    @staticmethod
    def _extract_from_pdf(file_path: str) -> str:
        """–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF"""
        full_text = []
        try:
            with open(file_path, 'rb') as f:
                reader = PyPDF2.PdfReader(f)
                if len(reader.pages) == 0:
                    raise ValueError("PDF –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü")
                
                for page in reader.pages:
                    text = page.extract_text()
                    if text:
                        full_text.append(text)
                
                if not full_text:
                    raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ PDF")
                
                return "\n".join(full_text)
        except Exception as e:
            logger.error(f"PDF –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏: {str(e)}")
            raise

    @staticmethod
    def _extract_from_docx(file_path: str) -> str:
        """–ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ DOCX"""
        full_text = []
        try:
            doc = Document(file_path)
            if not doc.paragraphs and not doc.tables:
                raise ValueError("DOCX —Ñ–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ")
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–∞–≥—Ä–∞—Ñ–æ–≤
            for para in doc.paragraphs:
                if para.text.strip():
                    full_text.append(para.text)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü
            for table in doc.tables:
                for row in table.rows:
                    for cell in row.cells:
                        if cell.text.strip():
                            full_text.append(cell.text)
            
            if not full_text:
                raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ DOCX")
            
            return "\n".join(full_text)
        except Exception as e:
            logger.error(f"DOCX –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏: {str(e)}")
            raise

class VectorDB:
    """–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è ChromaDB"""
    
    def __init__(self):
        self.client = Client(settings=Settings(
            persist_directory=AppConfig.PERSIST_DIRECTORY,
            anonymized_telemetry=False
        ))
        self.embedding_function = embedding_functions.SentenceTransformerEmbeddingFunction(
            model_name=AppConfig.EMBEDDING_MODEL
        )
        self.collection = self._initialize_collection()

    def _initialize_collection(self):
        """–ü–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
        try:
            return self.client.get_or_create_collection(
                name="company_documents",
                embedding_function=self.embedding_function,
                metadata={"hnsw:space": "cosine"}
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏: {str(e)}")
            raise

    def add_document(self, document_id: str, text: str, metadata: Dict[str, Any] = None) -> None:
        """–ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞"""
        try:
            if not text or not isinstance(text, str):
                raise ValueError("–¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π")
            
            # –£–ª—É—á—à–µ–Ω–Ω—ã–π —á–∞–Ω–∫–∏–Ω–≥ –ø–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º
            sentences = sent_tokenize(text)
            chunks = []
            current_chunk = ""
            
            for sentence in sentences:
                if len(current_chunk) + len(sentence) <= AppConfig.CHUNK_SIZE:
                    current_chunk += " " + sentence
                else:
                    if current_chunk:
                        chunks.append(current_chunk.strip())
                    current_chunk = sentence
            
            if current_chunk:
                chunks.append(current_chunk.strip())

            if not chunks:
                raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–∏—Ç—å —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞–Ω–∫–∏")
            
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            base_metadata = metadata.copy() if metadata else {}
            metadatas = []
            ids = []
            
            for i, chunk in enumerate(chunks):
                chunk_meta = base_metadata.copy()
                chunk_meta.update({
                    "chunk_id": i,
                    "total_chunks": len(chunks),
                    "document_id": document_id,
                    "timestamp": datetime.now().isoformat()
                })
                metadatas.append(chunk_meta)
                ids.append(f"{document_id}_{i}")
            
            # –í—Å—Ç–∞–≤–∫–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
            self.collection.add(
                documents=chunks,
                ids=ids,
                metadatas=metadatas
            )
            
            logger.info(f"–î–æ–∫—É–º–µ–Ω—Ç {document_id} –¥–æ–±–∞–≤–ª–µ–Ω ({len(chunks)} —á–∞–Ω–∫–æ–≤)")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞: {str(e)}", exc_info=True)
            raise

    def query(self, query_text: str, n_results: int = 3) -> List[str]:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞"""
        try:
            if not query_text or not isinstance(query_text, str):
                raise ValueError("–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π")
            
            results = self.collection.query(
                query_texts=[query_text],
                n_results=n_results,
                include=["documents", "metadatas", "distances"]
            )
            
            logger.debug(f"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: {results}")
            return results['documents'][0]
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)}")
            raise

class GigaChatClient:
    """–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç GigaChat —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    
    def __init__(self, vector_db: VectorDB):
        self.vector_db = vector_db
        self.client = self._initialize_client()

    def _initialize_client(self) -> GigaChat:
        """–ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞"""
        try:
            return GigaChat(
                credentials=AppConfig.GIGACHAT_CREDENTIALS,
                verify_ssl_certs=False,
                timeout=30
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GigaChat: {str(e)}")
            raise

    def send_message(self, prompt: str) -> Optional[str]:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å RAG"""
        try:
            if not prompt or not isinstance(prompt, str):
                raise ValueError("–ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π")
            
            # –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
            relevant_docs = self.vector_db.query(prompt)
            if not relevant_docs:
                raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤")
            
            context = "\n\n".join([
                f"–ò—Å—Ç–æ—á–Ω–∏–∫ {i+1}:\n{doc}" 
                for i, doc in enumerate(relevant_docs)
            ])
            
            # –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ–º—Ç —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            system_message = Messages(
                role=MessagesRole.SYSTEM,
                content=f"""
–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏, –ø–æ–º–æ–≥–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –¢—ã –¥–æ–ª–∂–µ–Ω —Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–∞–≤–∏–ª:

1. –ü–æ–∏—Å–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö:

–í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –∏—â–∏ –æ—Ç–≤–µ—Ç –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö {context}

–ï—Å–ª–∏ —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞–π–¥–µ–Ω, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –µ–≥–æ, —É–∫–∞–∑–∞–≤ –∏—Å—Ç–æ—á–Ω–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç—É X...").

2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–µ—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö):

–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö, –Ω–æ –∑–∞–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç, –Ω–æ–≤–æ—Å—Ç–∏, —Å–æ–±—ã—Ç–∏—è), –≤—ã–ø–æ–ª–Ω–∏ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–µ—Å–ª–∏ —ç—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Å–∏—Å—Ç–µ–º–æ–π).

–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–Ω–∞—è –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –¥–∞–Ω–Ω—ã–º –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —É–∫–∞–∂–∏ –Ω–∞ —ç—Ç–æ:
"–í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö —É–∫–∞–∑–∞–Ω–æ: [–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã]. –û–¥–Ω–∞–∫–æ, —Å–æ–≥–ª–∞—Å–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º: [–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞]. –†–µ–∫–æ–º–µ–Ω–¥—É—é —É—Ç–æ—á–Ω–∏—Ç—å —É –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞."

3. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç –Ω–∏–≥–¥–µ:

–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –Ω–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö, –Ω–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –æ—Ç–≤–µ—Ç—å:
"–ù–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∏–º–µ—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö. –†–µ–∫–æ–º–µ–Ω–¥—É—é —É—Ç–æ—á–Ω–∏—Ç—å —É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏."

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:

–ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º.

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –¥–æ–ø–æ–ª–Ω—è—é—Ç –æ—Ç–≤–µ—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —É–∫–∞–∂–∏ —ç—Ç–æ:
"–°–æ–≥–ª–∞—Å–Ω–æ –Ω–∞—à–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º: [–æ—Ç–≤–µ—Ç]. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ, –≤ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö —É–∫–∞–∑–∞–Ω–æ: [—É—Ç–æ—á–Ω–µ–Ω–∏–µ]."
"""
            )
            
            user_message = Messages(
                role=MessagesRole.USER,
                content=prompt
            )
            
            chat = Chat(
                messages=[system_message, user_message],
                temperature=0.4,
                max_tokens=2000,
                top_p=0.9
            )
            
            response = self.client.chat(chat)
            return response.choices[0].message.content
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ GigaChat API: {str(e)}", exc_info=True)
            raise

class TelegramBot:
    """–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π Telegram –±–æ—Ç"""
    
    def __init__(self):
        self.token = AppConfig.TELEGRAM_BOT_TOKEN
        self.vector_db = VectorDB()
        self.gigachat = GigaChatClient(self.vector_db)
        self.application = self._configure_application()

    def _configure_application(self) -> Application:
        """–ü–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Telegram"""
        app = ApplicationBuilder().token(self.token).build()
        
        # –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        handlers = [
            CommandHandler("start", self.start_command),
            CommandHandler("help", self.help_command),
            CommandHandler("upload", self.upload_command),
            CommandHandler("db_status", self.db_status_command),
            MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message),
            MessageHandler(filters.Document.ALL, self.handle_document)
        ]
        
        for handler in handlers:
            app.add_handler(handler)
        
        app.add_error_handler(self.error_handler)
        return app

    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
        try:
            response = (
                "üîπ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ üîπ\n\n"
                "–Ø –º–æ–≥—É –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏.\n\n"
                "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
                "/help - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º\n"
                "/upload - –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)\n"
                "/db_status - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π\n\n"
                "–ü—Ä–æ—Å—Ç–æ –∑–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å, –∏ —è –æ—Ç–≤–µ—á—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏!"
            )
            await update.message.reply_text(response)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ start_command: {str(e)}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã")

    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help"""
        try:
            help_text = (
                "üìö –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –±–æ—Ç–∞:\n\n"
                "/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
                "/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
                "/upload - –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π (PDF, DOCX, TXT)\n"
                "/db_status - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π\n\n"
                "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å, –∏ —è –æ—Ç–≤–µ—á—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–ø–∞–Ω–∏–∏!"
            )
            await update.message.reply_text(help_text)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ help_command: {str(e)}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã")

    async def upload_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /upload"""
        try:
            user_id = str(update.message.from_user.id)
            if user_id not in AppConfig.ALLOWED_USERS:
                await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.")
                return
            
            await update.message.reply_text(
                "üì§ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç (PDF, DOCX –∏–ª–∏ TXT) –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.\n\n"
                "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10 –ú–ë"
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ upload_command: {str(e)}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã")

    async def db_status_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã —Å—Ç–∞—Ç—É—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            count = self.vector_db.collection.count()
            await update.message.reply_text(
                f"üìä –°—Ç–∞—Ç—É—Å –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:\n"
                f"–î–æ–∫—É–º–µ–Ω—Ç–æ–≤: {count}\n"
                f"–†–∞–∑–º–µ—Ä: {self._get_db_size()} –ú–ë"
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ db_status_command: {str(e)}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞")

    def _get_db_size(self) -> float:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            size_bytes = sum(
                f.stat().st_size for f in 
                Path(AppConfig.PERSIST_DIRECTORY).glob('**/*') 
                if f.is_file()
            )
            return round(size_bytes / (1024 * 1024), 2)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –ë–î: {str(e)}")
            return 0.0

    async def handle_document(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ò—Å—á–µ—Ä–ø—ã–≤–∞—é—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
        temp_path = None
        try:
            user_id = str(update.message.from_user.id)
            if user_id not in AppConfig.ALLOWED_USERS:
                await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.")
                return

            document = update.message.document
            file_name = document.file_name or "unnamed_file"
            file_size = document.file_size or 0

            # –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞
            if file_size > AppConfig.MAX_FILE_SIZE:
                raise ValueError(f"–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å–∏–º—É–º {AppConfig.MAX_FILE_SIZE//1024//1024} –ú–ë)")

            if not file_name.lower().endswith(('.pdf', '.docx', '.txt')):
                raise ValueError("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ PDF, DOCX –∏ TXT —Ñ–∞–π–ª—ã")

            # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
            suffix = Path(file_name).suffix
            with tempfile.NamedTemporaryFile(suffix=suffix, delete=False) as temp_file:
                temp_path = temp_file.name

            # –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
            await (await context.bot.get_file(document.file_id)).download_to_drive(temp_path)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Å–∫–∞—á–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            actual_size = os.path.getsize(temp_path)
            if actual_size != file_size:
                logger.warning(f"–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç: –æ–∂–∏–¥–∞–ª–æ—Å—å {file_size}, –ø–æ–ª—É—á–µ–Ω–æ {actual_size}")

            # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
            text = DocumentProcessor.extract_text_from_file(temp_path)
            if not text.strip():
                raise ValueError("–§–∞–π–ª –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω")

            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            metadata = {
                "uploaded_by": user_id,
                "filename": file_name,
                "file_size": file_size,
                "timestamp": datetime.now().isoformat(),
                "source": "telegram_upload"
            }

            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
            self.vector_db.add_document(
                document_id=file_name,
                text=text,
                metadata=metadata
            )

            await update.message.reply_text(
                f"‚úÖ –î–æ–∫—É–º–µ–Ω—Ç {file_name} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π!\n"
                f"–†–∞–∑–º–µ—Ä: {file_size//1024} –ö–ë\n"
                f"–°–∏–º–≤–æ–ª–æ–≤: {len(text)}"
            )

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {str(e)}", exc_info=True)
            error_msg = (
                f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞:\n"
                f"–ò–º—è: {file_name}\n"
                f"–¢–∏–ø: {document.mime_type if document else '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}\n"
                f"–û—à–∏–±–∫–∞: {str(e)}"
            )
            await update.message.reply_text(error_msg[:4000])  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è Telegram

        finally:
            if temp_path and os.path.exists(temp_path):
                try:
                    os.unlink(temp_path)
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {str(e)}")

    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            user_message = update.message.text
            user_id = update.message.from_user.id
            
            logger.info(f"–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –æ—Ç {user_id}: {user_message[:100]}...")
            
            await update.message.chat.send_action(action="typing")
            
            response = self.gigachat.send_message(user_message)
            if not response:
                raise ValueError("–ù–µ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç GigaChat")
            
            await update.message.reply_text(response[:4000])  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã Telegram
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {str(e)}", exc_info=True)
            await update.message.reply_text(
                "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )

    async def error_handler(self, update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
        error = context.error
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(error)}", exc_info=error)
        
        if isinstance(update, Update):
            await update.message.reply_text(
                "‚ö† –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É–∂–µ —É–≤–µ–¥–æ–º–ª–µ–Ω—ã.\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
            )

    def run(self) -> None:
        """–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        try:
            self.application.run_polling(
                drop_pending_updates=True,
                close_loop=False,
                stop_signals=None
            )
        except Exception as e:
            logger.critical(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {str(e)}", exc_info=e)
            raise

if __name__ == "__main__":
    """–ü–æ–ª–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π
        required_modules = [
            'gigachat', 'telegram', 'chromadb', 
            'PyPDF2', 'docx', 'nltk'
        ]
        
        import importlib
        for module in required_modules:
            importlib.import_module(module)
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NLTK —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
        try:
            import nltk
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏–∏
            nltk.download('punkt', quiet=True)
            nltk.download('punkt_tab', quiet=True)  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ NLTK –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
            # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –≤–æ–∑–º–æ–∂–Ω–æ, —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        
        # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
        bot = TelegramBot()
        bot.run()
        
    except ImportError as e:
        logger.critical(f"–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å: {str(e)}")
        print(f"–û—à–∏–±–∫–∞: {str(e)}\n–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–∞–∫–µ—Ç—ã: pip install {' '.join(required_modules)}")
    except Exception as e:
        logger.critical(f"–§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}", exc_info=e)
        print(f"–§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
